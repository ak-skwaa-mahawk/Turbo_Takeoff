environment:
  # Existing hardening vars...
  - N8N_BLOCK_ENV_ACCESS_IN_NODE=true
  - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
  # OTLP Pioneer â€“ send to Google Cloud unified endpoint
  - OTEL_EXPORTER_OTLP_ENDPOINT=https://telemetry.googleapis.com
  - OTEL_EXPORTER_OTLP_PROTOCOL=grpc           # or http if preferred
  - OTEL_EXPORTER_OTLP_HEADERS="Authorization=Bearer $(cat /run/secrets/gcp-credentials.json | jq -r .token)"  # Use secret mount
  - OTEL_SERVICE_NAME=n8n-wasilla-relay
  - OTEL_RESOURCE_ATTRIBUTES=deployment.environment=production,service.owner=twomilesolutions,service.version=1.0
secrets:
  - gcp-credentials
location /opentelemetry {
    proxy_pass https://telemetry.googleapis.com;
    proxy_set_header Host telemetry.googleapis.com;
    proxy_ssl_server_name on;
    # Block any unexpected path manipulation
    if ($request_uri \~* "(\.\./|%2e%2e/)") { return 403; }
}
# prometheus.yml addition
scrape_configs:
  - job_name: 'otlp'
    static_configs:
      - targets: ['localhost:4317']  # OTLP gRPC receiver
services:
  n8n-relay:
    # ... existing hardening ...
    environment:
      - OTEL_EXPORTER_OTLP_ENDPOINT=https://telemetry.googleapis.com
      - OTEL_SERVICE_NAME=n8n-wasilla-relay
      - GOOGLE_APPLICATION_CREDENTIALS=/run/secrets/gcp_key
    secrets:
      - gcp_key

secrets:
  gcp_key:
    file: ./gcp-observability-key.json

services:
  # ... existing n8n and nginx services ...

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    user: "65534:65534"  # nobody:nogroup
    read_only: true
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    tmpfs:
      - /tmp:size=16m,mode=1777
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - secure-internal
    cap_drop:
      - ALL

  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:latest
    container_name: nginx-exporter
    restart: unless-stopped
    user: "65534:65534"
    read_only: true
    command:
      - "--nginx.scrape-uri=http://nginx:8080/stub_status"
    networks:
      - secure-internal
    depends_on:
      - nginx
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

volumes:
  prometheus-data:

networks:
  secure-internal:
    driver: bridge
services:
  # ... existing n8n and nginx services ...

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    networks:
      - secure-internal

  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:latest
    command:
      - "--nginx.scrape-uri=http://nginx:8080/stub_status"
    networks:
      - secure-internal
    depends_on:
      - nginx

services:
  n8n-relay:
    image: n8nio/n8n:1.123.17
    restart: unless-stopped
    user: "1000:1000"
    read_only: true
    tmpfs:
      - /home/node/.n8n:size=64m,mode=1777
      - /tmp:size=16m,mode=1777
    environment:
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=true
      - N8N_DISABLE_PRODUCTION_MAIN_PROCESS_TERMINATION=true
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_LOG_LEVEL=error          # Minimize noise / logging surface
      - N8N_ENCRYPTION_KEY_FILE=/home/node/.n8n/encryption.key  # Separate key file
    volumes:
      - ./n8n_data:/home/node/.n8n:rw
      - ./encryption.key:/home/node/.n8n/encryption.key:ro  # Key outside DB dir
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    networks:
      - secure-internal

services:
  n8n-relay:
    image: n8nio/n8n:1.123.17 # Hardened and verified
    restart: unless-stopped
    # Use a non-root user (node) mapped to a low-priv host UID
    user: "1000:1000"
    environment:
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=true
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
    # Starve the process of filesystem write access
    read_only: true
    tmpfs:
      - /home/node/.n8n:size=50M
      - /tmp:size=10M
    volumes:
      - ./n8n_data:/home/node/.n8n:rw # Persistent database storage
    # Security capabilities: Drop everything
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
