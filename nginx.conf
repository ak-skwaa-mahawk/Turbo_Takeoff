server {
    listen 443 ssl http2;
    server_name relay.twomilesolutions.local;

    # HULL INTEGRITY: Normalize paths and disable leaky redirects
    merge_slashes on;
    absolute_redirect off;

    # SENTINEL: Block encoded traversal at the very edge (CVE-2026-1731 logic)
    if ($request_uri \~* "(?:\.\./|%2e%2e/|%252e%252e/|%5c|%2f\.\.)") {
        return 403;
    }

    # SENTINEL: Block command injection characters and BT-style probing
    if (\( request_uri \~* "(?:/appliance/|/api/|/scripts/.*[;&|` \)])") {
        return 444; 
    }

    # IDENTITY LOCK: Force strict host header validation
    if (\( host !\~* ^(relay\.twomilesolutions\.local|127\.0\.0\.1|localhost) \) ) {
        return 444;
    }

    location / {
        # PROXY GATING: Handover to the starved n8n container
        proxy_pass http://n8n-relay:5678;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # SECURITY HEADERS: Strict origin enforcement
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Content-Security-Policy "default-src 'self';" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    }
}

server {
    listen 443 ssl http2;
    server_name relay.twomilesolutions.local;

    # HULL INTEGRITY: Normalize paths and disable leaky redirects
    merge_slashes on;
    absolute_redirect off;

    # SENTINEL: Block encoded traversal at the very edge (CVE-2026-1731 logic)
    if ($request_uri ~* "(?:\.\./|%2e%2e/|%252e%252e/|%5c|%2f\.\.)") {
        return 403;
    }

    # SENTINEL: Block command injection characters and BT-style probing
    if ($request_uri ~* "(?:/appliance/|/api/|/scripts/.*[;&|`$])") {
        return 444; 
    }

    # IDENTITY LOCK: Force strict host header validation
    if ($host !~* ^(relay\.twomilesolutions\.local|127\.0\.0\.1|localhost)$ ) {
        return 444;
    }

    location / {
        # PROXY GATING: Handover to the starved n8n container
        proxy_pass http://n8n-relay:5678;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # SECURITY HEADERS: Strict origin enforcement
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Content-Security-Policy "default-src 'self';" always;
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    }
}
# Add to Nginx Hull to alert on RDS/MSRDP discovery probes (CVE-2025-32701)
if ($request_uri ~* "(?:/RemoteDesktop/|/msrdp/|/RDWeb/|/rpc/rpcproxy\.dll)") {
    return 444; # Drop silently; starve the scanner
}

