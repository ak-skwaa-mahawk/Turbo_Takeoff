# Block encoded traversal at the very edge
if ($request_uri \~* "(?:\.\./|%2e%2e/|%252e%252e/|%5c|%2f\.\.)") {
    return 403;
}

# Force strict host header validation (prevents host-header injection)
if (\( host !\~* ^relay\.twomilesolutions\.local \)|^127\.0\.0\.1\( |^localhost \) ) {
    return 444;
}

server {
    listen 443 ssl http2;
    server_name relay.twomilesolutions.local;

    # Normalize paths to prevent CVE-style bypasses
    merge_slashes on;
    # Disable "clever" redirecting that can leak internal ports
    absolute_redirect off;

    location / {
        # Strict proxying to the internal relay
        proxy_pass http://n8n-relay:5678;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        
        # Block common-mode traversal patterns at the hull
        if ($request_uri ~* "(\.\./|%2e%2e/|%252e%252e/)") {
            return 403;
        }
        
        # Security Headers
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header Content-Security-Policy "default-src 'self';" always;
    }
}
